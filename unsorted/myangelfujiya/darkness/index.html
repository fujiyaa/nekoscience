<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>osu! тренажёр с кликами и скоростью</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #ddd;
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: #2c2c2c;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      padding: 16px;
      margin-bottom: 16px;
    }
    #controls {
      width: 260px;
      display: flex;
      flex-direction: column;
    }
    label { font-size: 14px; margin-bottom: 6px; display: block; }
    input, select { width: 100%; margin-bottom: 12px; padding: 6px; border-radius: 6px; border: none; outline: none; }
    button { padding: 8px; background: #4cafef; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #399cd6; }
    #game { width: 320px; height: 500px; border: 2px solid #444; border-radius: 12px; position: relative; background: #111; overflow: hidden; }
    .note { width: 40px; height: 20px; background: #4caf50; position: absolute; left: 140px; border-radius: 4px; }
    #hitline { position: absolute; bottom: 50px; left: 0; width: 100%; height: 4px; background: #fff; }
    #stats { flex: 1; display: flex; flex-direction: column; gap: 16px; }
    #chart { border: 1px solid #555; border-radius: 8px; background: #000; }
    .fade-miss { background: #f44336 !important; }
  </style>
</head>
<body>
  <div id="controls">
    <div class="card">
      <label>Клавиши (через запятую):</label>
      <input id="keys" value="z,x">
      <label>OD:</label>
      <input id="od" type="number" value="5" min="1" max="10">
      <label>BPM:</label>
      <input id="bpm" type="number" value="120">
      <label>Количество кликов для окончания:</label>
      <input id="maxClicks" type="number" value="50" min="1">
      <label>Скорость нот:</label>
      <input id="speedSlider" type="range" min="0.5" max="2" step="0.1" value="1">
      <label><input type="checkbox" id="metronome"> Метроном</label>
      <button id="start">Старт</button>
    </div>
    <div class="card" id="scoreBlock">
      <h4>Результаты</h4>
      <div id="results">300:0 100:0 50:0 Miss:0</div>
    </div>
    <div class="card" id="extraBlock">
      <h4>Дополнительно</h4>
      <div>UR: <span id="ur">0.00</span></div>
      <div>Реальный BPM: <span id="realBpm">0</span></div>
    </div>
  </div>

  <div id="game">
    <div id="hitline"></div>
  </div>

  <div id="stats">
    <div class="card">
      <h4>График скорости</h4>
      <canvas id="chart" width="400" height="500"></canvas>
    </div>
  </div>

  <script>
    const game = document.getElementById("game");
    const startBtn = document.getElementById("start");
    const results = document.getElementById("results");
    const chart = document.getElementById("chart");
    const ctx = chart.getContext("2d");
    const urEl = document.getElementById("ur");
    const bpmEl = document.getElementById("realBpm");
    const metronomeChk = document.getElementById("metronome");
    const speedSlider = document.getElementById("speedSlider");
    const maxClicksInput = document.getElementById("maxClicks");

    let keys = ["z","x"];
    let od = 5, bpm = 120;
    let notes = [];
    let timer, metronomeTimer;
    let score = {300:0,100:0,50:0,miss:0};
    let pressTimes = [];
    let hitErrors = [];
    let audioCtx;
    let totalClicks = 0;
    let maxClicks = 50;
    let speedFactor = 1;

    function updateResults() {
      results.textContent = `300:${score[300]} 100:${score[100]} 50:${score[50]} Miss:${score.miss}`;
    }

    function spawnNote() {
      const note = document.createElement("div");
      note.className = "note";
      note.style.top = "-20px";
      game.appendChild(note);
      notes.push({el:note,time:performance.now()+2000,hit:false});
    }

    function animateHit(note) {
      const xOffset = (Math.random()-0.5)*50;
      const yOffset = -50 - Math.random()*50;
      note.style.transition = "transform 0.5s ease, opacity 0.5s ease";
      note.style.transform = `translate(${xOffset}px, ${yOffset}px) rotate(${(Math.random()-0.5)*60}deg)`;
      note.style.opacity = 0;
      setTimeout(()=>note.remove(),500);
    }

    function animateMiss(note) {
      note.classList.add("fade-miss");
      note.style.transition = "opacity 0.5s ease";
      note.style.opacity = 0;
      setTimeout(()=>note.remove(),500);
    }

    

    function gameLoop() {
      const now = performance.now();
      notes.forEach(n => {
        if(n.hit) return;
        const y = (now - (n.time-2000)) / 2000 * (game.clientHeight - 50) * speedFactor;
        n.el.style.top = y + "px";
        if(y > game.clientHeight - 50 && !n.hit) {
          n.hit=true;
          score.miss++;
          animateMiss(n.el);
          updateResults();
        }
      });
      notes = notes.filter(n => !n.hit || n.el.isConnected);
      requestAnimationFrame(gameLoop);
    }

    function handleKey(e) {
      if(!keys.includes(e.key)) return;
      totalClicks++;
      const now = performance.now();
      pressTimes.push(now);
      if(pressTimes.length>100) pressTimes.shift();

      let best=null, delta=Infinity;
      notes.forEach(n=>{
        if(n.hit) return;
        const d = now - n.time;
        if(Math.abs(d)<Math.abs(delta)) { delta=d; best=n; }
      });
      if(best && Math.abs(delta)<300) {
        best.hit=true;
        hitErrors.push(delta);
        if(hitErrors.length>200) hitErrors.shift();

        if(Math.abs(delta)<od*15) score[300]++;
        else if(Math.abs(delta)<od*30) score[100]++;
        else score[50]++;

        animateHit(best.el);
        updateResults();
      }
      drawChart();
      updateExtra();

      if(totalClicks>=maxClicks) stopGame();
    }

    function updateExtra() {
      if(hitErrors.length>1) {
        const mean = hitErrors.reduce((a,b)=>a+b,0)/hitErrors.length;
        const variance = hitErrors.reduce((a,b)=>a+(b-mean)**2,0)/hitErrors.length;
        urEl.textContent = (Math.sqrt(variance)*10).toFixed(2);
      }
      if(pressTimes.length>1) {
        const diffs = [];
        for(let i=1;i<pressTimes.length;i++) diffs.push(pressTimes[i]-pressTimes[i-1]);
        const avg = diffs.reduce((a,b)=>a+b,0)/diffs.length;
        bpmEl.textContent = (60000/avg).toFixed(1);
      }
    }

    function drawChart() {
      ctx.fillStyle="black";
      ctx.fillRect(0,0,chart.width,chart.height);
      ctx.strokeStyle="lime";
      ctx.beginPath();
      for(let i=1;i<pressTimes.length;i++) {
        const diff = 60000/(pressTimes[i]-pressTimes[i-1]);
        ctx.lineTo(i*4, chart.height - diff*2);
      }
      ctx.stroke();
    }

    let beatCount = 0;
    function startMetronome() {
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      beatCount = 0;
      metronomeTimer = setInterval(()=>{
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        if(beatCount % 4 === 0) { // сильная доля
          osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
          gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        } else { // слабые доли
          osc.frequency.setValueAtTime(800, audioCtx.currentTime);
          gain.gain.setValueAtTime(0.07, audioCtx.currentTime);
        }
        osc.type = "square";
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
        beatCount++;
      }, 60000/bpm);
    }


    function stopMetronome() { clearInterval(metronomeTimer); }

    function stopGame() {
      clearInterval(timer); // останавливаем спавн нот
      // оставляем метроном работать, пока есть ноты
      const checkNotes = setInterval(() => {
        if(notes.length === 0) { 
          clearInterval(metronomeTimer);
          clearInterval(checkNotes);
        }
      }, 50);
    }


    startBtn.onclick = () => {
      game.innerHTML = '<div id="hitline"></div>';
      score={300:0,100:0,50:0,miss:0};
      updateResults();
      notes=[]; pressTimes=[]; hitErrors=[];
      totalClicks=0;
      keys=document.getElementById("keys").value.split(",").map(k=>k.trim());
      od=parseInt(document.getElementById("od").value);
      bpm=parseInt(document.getElementById("bpm").value);
      maxClicks = parseInt(maxClicksInput.value);
      speedFactor = parseFloat(speedSlider.value);

      clearInterval(timer);
      if(metronomeTimer) stopMetronome();
      if(metronomeChk.checked) startMetronome();

      timer=setInterval(spawnNote, (60000/(bpm*2))/speedFactor);
      gameLoop();
    };

    document.addEventListener("keydown", handleKey);
  </script>
</body>
</html>
